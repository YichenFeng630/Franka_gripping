#!/usr/bin/env python3
"""
点云处理管道诊断工具
逐步分析每个处理步骤对精度的影响
"""

import subprocess
import json
import time

diagnosis = """
╔════════════════════════════════════════════════════════════════════════════╗
║                    🔬 理智分析：方案1为什么不合理                          ║
╚════════════════════════════════════════════════════════════════════════════╝

📊 数据事实：
═════════════════════════════════════════════════════════════════════════════

Z轴误差分布：
  ├─ RED_1:    +3.0mm     ✓ 优秀
  ├─ BLUE_2:  +25.7mm     ✗ 很差
  ├─ GREEN_3: +26.5mm     ✗ 很差
  └─ YELLOW_4: +3.3mm     ✓ 优秀

分布特征：
  • 不均匀（3mm vs 26mm）
  • 相邻的cube误差天差地别
  • 没有规律可循


❌ 方案1的逻辑推导过程错误：
═════════════════════════════════════════════════════════════════════════════

我之前的推导：
  前提：「Z轴误差很稳定」
  结论：「这是系统性偏差」
  方案：「减去25mm」

❌ 错误在于：
  前提本身就错了！
  3mm 和 25mm 根本不稳定！
  标准差 11.7mm 说明差异很大！


✅ 正确的数据解读：
═════════════════════════════════════════════════════════════════════════════

观察 1：位置模式
  ├─ 红色(X=0.650, Y=0.150):  Z误差 3mm
  ├─ 蓝色(X=0.650, Y=-0.150): Z误差 26mm    ← 同一X，不同Y！
  ├─ 绿色(X=0.350, Y=0.150):  Z误差 26mm    ← 同一Y，不同X！
  └─ 黄色(X=0.350, Y=-0.150): Z误差 3mm

观察 2：相机视角假设
  • 相机在上方看下来
  • 红色和黄色离相机可能更近（点云质量好）
  • 蓝色和绿色离相机可能更远（点云质量差）
  → Z深度估计不准

观察 3：ICP配准质量
  • 所有cube的ICP fitness都是1.0（完美）
  • 但位置误差差异很大
  • 说明ICP初值（聚类结果）有问题

结论：
  这是 【聚类和ICP初值问题】，不是坐标系偏差问题！


🚫 为什么直接减25mm会失败：
═════════════════════════════════════════════════════════════════════════════

假设你改代码减去25mm：

对RED_1的影响：
  检测Z: 0.025m
  减后Z: 0.025 - 0.025 = 0.000m
  真值Z: 0.022m
  新误差: 22mm ❌ 变差了！

对YELLOW_4的影响：
  检测Z: 0.025m
  减后Z: 0.025 - 0.025 = 0.000m
  真值Z: 0.022m
  新误差: 22mm ❌ 变差了！

代价：
  √ BLUE_2:  26.5 - 25 = 1.5mm  (改善)
  √ GREEN_3: 26.5 - 25 = 1.5mm  (改善)
  ✗ RED_1:    3.0 - 25 = -22mm  (恶化)
  ✗ YELLOW_4: 3.3 - 25 = -21.7mm (恶化)
  
  平均从15.1mm → 大约15-18mm（没有改善，甚至变差！）


💡 正确的诊断思路：
═════════════════════════════════════════════════════════════════════════════

Q1: 为什么某些cube准，某些不准？
  └─ 需要逐个分析每个cube的点云质量
  
Q2: 是聚类问题吗？
  └─ 检查DBSCAN参数是否对所有位置都适用
  
Q3: 是ICP初值问题吗？
  └─ 检查聚类质心是否准确
  
Q4: 是相机标定问题吗？
  └─ 检查Z轴是否存在非线性误差（近处好，远处差）


✅ 理智的解决方案：
═════════════════════════════════════════════════════════════════════════════

【推荐】方案3：参数自动优化
  • 搜索DBSCAN_eps, voxel_size, ransac_dist
  • 找到让所有4个cube都精准的参数组合
  • 20分钟自动完成，科学可靠
  
【备选】方案2：参数微调
  • 增大dbscan_eps (0.02 → 0.025)
    └─ 改善点云聚类效果
  • 减小voxel_size (0.005 → 0.004)
    └─ 提高点云精度
  • 增大ransac_dist (0.01 → 0.015)
    └─ 更好地去除桌面

【避免】方案1：直接Z轴补正
  • 会破坏已经精准的cube
  • 掩盖真正的问题
  • 不科学，容易翻车


📋 建议的实施顺序：
═════════════════════════════════════════════════════════════════════════════

  1️⃣ 先运行方案3（自动优化）
     └─ 花20分钟找到最优参数
     
  2️⃣ 如果改善了 → 完成 ✅
  
  3️⃣ 如果改善不足 → 再分析为什么
     └─ 是否需要检查TF变换
     └─ 是否需要检查相机模型


╚════════════════════════════════════════════════════════════════════════════╝
"""

print(diagnosis)

print("\n\n推荐的下一步行动：")
print("═" * 80)
print("""
【立即执行】
  cd /opt/ros_ws
  python3 src/franka_perception/scripts/calibrate_params.py
  
  这会自动测试所有参数组合，找到最优解。
  
【预期结果】
  ✓ 平均误差 15.1mm → 5-10mm（很可能）
  ✓ 所有cube都会改善（不是破坏某些）
  ✓ 完全自动，不需要手工调整

【如果仍未达标】
  再分析具体是哪个步骤有问题
  • 点云滤波？
  • 聚类？
  • ICP初值？
  • TF变换？
""")
